# AndroidPentestGuide
AAPG
===========================================================================
============================== 0) Used Tools ==============================
===========================================================================

a) apktool
    -) AUR package: yay -S android-apktool
b) dex2jar
c) jd-gui
d) jadx
e) adb
    -) sudo pacman -S android-tools
    -) I personally would recommend installing android-studio (it comes with the SDK - including all platform-tools)
        o) sudo pacman -S andriod-studio
f) bettercap
    -) sudo pacman -S bettercap
g) dnSpy
    -) .NET decompiler (in case of Xamarin Apps)
h) enjarify
i) apk decompiler for lazy: https://github.com/b-mueller/apkx

==========================================================================
===================== 1) MANUAL STATIC ANALYSIS ==========================
==========================================================================
////////////////
1a) RETRIEVE APK
////////////////

    FROM THE DEVICE ITSELF
        [COMMANDS]
            o) adb shell pm list packages (list all installed packages)
            o) adb shell pm path com.x.x.x (display apk path of package)
            o) adb pull /data/data/com.x.x.x/app_name.apk (copy the apk file to your system)

    APK DOWNLOADER
        1) Search for your application @ https://play.google.com/store
        2) Copy URL (i.e: https://play.google.com/store/apps/details?id=com.whatsapp)
        3) Paste URL into one of the downloaders below or one of your own choice:
            o) evozi
            o) apkcombo (recommended)
            o) apkmirror
/////////////////
1b) DECOMPILE APK
/////////////////

    UNZIP (I'm aware this is just unpacking - not decompiling)
        [COMMANDS]
            o) unzip app_name.apk
        [INFO]
            -) quick & dirty way
            -) Manifest.xml is not readable
            -) However .dex files can be found -> d2j-dex2jar
            -) certs + signature-files available

    APKTOOL
        [COMMANDS]
            o) apktool d path/to/your/app_name.apk (decompiles .dex files to .smali)
            o) apktool d --no-src app_name.apk (does NOT decompile .dex files to .smali)
        [INFO]
            -) not all files do get extracted: i.e certs + signature files & more are missing

    DEX2JAR
        [COMMANDS]
            o) d2j-dex2jar app_name.apk
        [INFO]
            -) extracts decompiled .jar only & app_name-error.zip (open with jd-gui)

    JADX
        [COMMANDS]
            o) jadx -d path/to/extract/ --deobf app_name.apk (jadx-deobfuscator -> deobfs simple obf. code)
            o) jadx -d path/to/extract/ app_name.apk
            o) jadx -d path/to/extract/ classes.dex (outputs .java files at path/to/extract/sources/)
        [INFO]
            -) RECOMMENDED!!
            -) resources + sources available (source code + certs, ...)

    DEOBFUSCATION
        [COMMANDS]
            o) jadx -d path/to/extract/ --deobf app_name.apk
            o) simplify -i file_name.smali -o class.dex
        [INFO]
            -) no 100% success guaranteed --> works only with simple obfuscated files
            -) to get the file_name.smali --> decompile with APKTOOL

    XAMARIN
        [COMMANDS]
            o) 7z e app_name.apk (unzip apk and retrieve *.dll files)
        [INFO]
            -) Xamarin Apps are written in C#, therefore you have to decompile it on a windows machine (i.e. dnSpy)
            -) Main Code can be found in app_name.dll (but usually there are more too)

/////////////////////
1c) CHECK CERTIFICATE
/////////////////////

    [COMMANDS]
        o) openssl pkcs7 -inform DER -in META-INF/*.RSA -noout -print_certs -text
        o) jarsigner -verify -verbose -certs app_name.apk (optional)

    [INFO]   
        -) jarsigner --> huge output (each file gets validated)
        -) cert location:
            -) unzip.apk --> META-INF/*.RSA
            -) jadx app_name.apk --> resources/META-INF/*.RSA
        -) custom CAs may be definded: res/xml/network_security_config.xml (or similar name)
            -) also cert-pinning info available there (i.e expiration)

    [THINGS TO REPORT]
        !) CN=Android Debug (=debug cert -> public known private key)
        !) CA is expired
        !) The CA that issued the server certificate was unknown
        !) CA was self signed
        !) The server configuration is missing an intermediate CA
        !) no cert-pinning (public key pinning) enabled (if you are able to route traffic through a proxy)
        !) cleartext Traffic is allowed (until Android 8.1):
            -) <base-config cleartextTrafficPermitted="true">
            -) <domain-config cleartextTrafficPermitted="true">

    [MORE DETAILS]
        ?) Manifest permissions
        ?) SSL common problems
        ?) ssltest

///////////////////////////////
1d) ANALYZE ANDROIDMANIFEST.XML
///////////////////////////////

    [COMMANDS]
        RETRIEVE MANIFEST ONLY (already covered if you have properly decompiled the app)
            o) aapt dump app_name.apk AndroidManifest.xml > manifest.txt
            o) aapt l -a app_name.apk > manifest.txt
            o) run app.package.manifest com.x.x.x (within drozer-shell "dr>")

        CREATE BACKUP
            o) adb backup -all -apk -shared (full backup)
            o) adb backup com.x.x.x (single app backup)
            o) decode unencrypted backup
                o) xxd backup.ab (check if encrypted --> if you see "none" --> not encrypted)
                o) dd if=all-data.ab bs=24 skip=1 | openssl zlib -d > all-data.tar
                    o) tar xvf all-data.tar (extract tar-archive)
       
    [INFO]
